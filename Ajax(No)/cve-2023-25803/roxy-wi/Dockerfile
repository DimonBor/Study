FROM centos:centos8

WORKDIR /var/www/

#Prepare Env
ENV PATH="${PATH}:/root/.cargo/bin"
RUN sed -i 's/mirrorlist/#mirrorlist/g' /etc/yum.repos.d/CentOS-*
RUN sed -i 's|#baseurl=http://mirror.centos.org|baseurl=http://vault.centos.org|g' /etc/yum.repos.d/CentOS-*

#Install deps
RUN yum -y install curl lshw sudo openssh openssh-clients gcc gcc-c++ make python36 python3-pip python3-devel python3-cryptography python3-jinja2 python3-distro nmap-ncat net-tools lshw python3-ldap rsync dos2unix nmap mod_ssl httpd python3-mod_wsgi libmodulemd python3-psutil httpd wget unzip openssl
RUN curl https://sh.rustup.rs -sSf | sh -s -- -y
RUN source "$HOME/.cargo/env"
RUN echo "Defaults lecture = never" > /etc/sudoers.d/custom
RUN echo "root ALL=(ALL:ALL) NOPASSWD: ALL" >> /etc/sudoers.d/custom
RUN echo "apache ALL=(ALL:ALL) NOPASSWD: ALL" >> /etc/sudoers.d/custom

#Get sources
RUN mkdir /var/www/haproxy-wi
RUN wget https://github.com/hap-wi/roxy-wi/archive/refs/tags/v6.3.4.0.zip
RUN unzip v6.3.4.0.zip 
RUN cp -r ./roxy-wi-6.3.4.0/* ./haproxy-wi

#Install python deps
RUN python3 -m pip install setuptools_rust
RUN python3 -m pip install -r haproxy-wi/config_other/requirements_el8.txt
RUN python3 -m pip install paramiko-ng pynacl pika

#Install sources  
RUN cp haproxy-wi/config_other/httpd/roxy-wi.conf /etc/httpd/conf.d/
RUN cp haproxy-wi/config_other/logrotate/* /etc/logrotate.d/
RUN mkdir /var/lib/roxy-wi/
RUN mkdir /var/lib/roxy-wi/keys/
RUN mkdir /var/lib/roxy-wi/configs/
RUN mkdir /var/lib/roxy-wi/configs/hap_config/
RUN mkdir /var/lib/roxy-wi/configs/kp_config/
RUN mkdir /var/lib/roxy-wi/configs/nginx_config/
RUN mkdir /var/lib/roxy-wi/configs/apache_config/
RUN mkdir /var/log/roxy-wi/
RUN mkdir /etc/roxy-wi/
RUN mv haproxy-wi/roxy-wi.cfg /etc/roxy-wi
RUN sed -i "s/localhost/172\.22\.1\.1/" /etc/httpd/conf.d/roxy-wi.conf
RUN openssl req -newkey rsa:4096 -nodes -keyout /var/www/haproxy-wi/app/certs/haproxy-wi.key -x509 -days 10365 -out /var/www/haproxy-wi/app/certs/haproxy-wi.crt -subj "/C=US/ST=Almaty/L=Springfield/O=Roxy-WI/OU=IT/CN=*.roxy-wi.org/emailAddress=aidaho@roxy-wi.org"
RUN chown -R apache:apache /var/www/haproxy-wi/
RUN chown -R apache:apache /var/lib/roxy-wi/
RUN chown -R apache:apache /var/log/roxy-wi/
RUN chown -R apache:apache /etc/roxy-wi/

#Gen certs and fix file permissions
RUN /usr/libexec/httpd-ssl-gencerts
RUN find /var/www/haproxy-wi/app/ -name '*.py' -exec chmod +x {} \; 

#Create roxy DB
RUN /var/www/haproxy-wi/app/create_db.py
RUN chown -R apache:apache /var/www/haproxy-wi/
RUN chown -R apache:apache /var/lib/roxy-wi/

#Copy private SSH key
COPY ./apache /root/.ssh/

#Start main process
CMD [ "apachectl", "-DFOREGROUND"]
