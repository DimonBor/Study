FROM httpd:2.4

WORKDIR /

#Install sshd
RUN apt-get update && apt-get install -y openssh-server sudo lshw
RUN mkdir /var/run/sshd

#Setup sshd
RUN echo 'root:root' | chpasswd
RUN sed -i 's/PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config
RUN sed 's@session\s*required\s*pam_loginuid.so@session optional pam_loginuid.so@g' -i /etc/pam.d/sshd
RUN echo 'ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBH4oIzM9VOuuW8HUeui3pwCiK/qARB+smJr7r7Ul04Vd53B9/cfb0bMlTlgqNBafUVnIAPfY3n2Io4aTDB1NmhU=' > /root/.ssh/authorized_keys

RUN echo "Defaults lecture = never" > /etc/sudoers.d/custom
RUN echo "root ALL=(ALL:ALL) NOPASSWD: ALL" >> /etc/sudoers.d/custom
RUN echo "apache ALL=(ALL:ALL) NOPASSWD: ALL" >> /etc/sudoers.d/custom

EXPOSE 22

#Prepare main script
COPY ./run_apache.sh /
RUN chmod a+x /run_apache.sh

#Preapre apache config
COPY ./custom.conf /usr/local/apache2/conf/
RUN cat /usr/local/apache2/conf/custom.conf >> /usr/local/apache2/conf/httpd.conf
RUN mkdir /etc/httpd
RUN mkdir /var/log/httpd/
COPY ./server-status_htpasswd /etc/httpd/server-status_htpasswd
RUN sed -i "s/ErrorLog.*/ ErrorLog \/var\/log\/httpd\/httpd-error.log/g" /usr/local/apache2/conf/httpd.conf 
RUN sed -i "s/CustomLog.*/CustomLog \/var\/log\/httpd\/httpd-access.log combined/g" /usr/local/apache2/conf/httpd.conf

EXPOSE 8087

#Prepare a flag to steal
RUN echo "2023-12-30 00:35:24 My total sercret information.\n2023-12-30 00:35:24 Hope nobody will access it.\n2023-12-30 00:35:24 Nobody... I mean, never. https://www.youtube.com/watch?v=dQw4w9WgXcQ"> /flag.txt

CMD [ "./run_apache.sh"]
